@model dynamic

@{
    Layout = "~/Views/Shared/_LayoutSite.cshtml";
    ViewBag.Title = "Search Results";
}

<div class="header">
    <a class="home-button" href="#">
        <span class="twitta-logo"></span>
        <span class="label">Twitta</span>
    </a>

    <button class="button-graph-transparent">
        <span class="fa fa-bar-chart-o"></span>
        <span class="label">Graph 1</span>
    </button>

    @Html.ActionLink("View Errors", "Exceptions", "Error", new { @class = "button-graph-transparent" })
</div>

<div class="wrapper-keywords">
    <ul id="results">
        <!-- ko foreach: words -->
        <li>
            <a href="#" data-bind="click: getExpandedTweets, text: word, attr: { href: getExpandedTweetsUrl }"></a>:
            <!--ko text: total --><!--/ko-->
        </li>
        <!-- /ko -->
    </ul>
</div>

<div class="wrapper-search-content">
    <p>
        <label for="amount">Range:</label>
        <input type="text" id="amount" style="border:0; color:#f6931f; font-weight:bold;">
    </p>

    <div id="slider-range" style="width:50%"></div>
    <h2>Search Results</h2>

    <ul id="expandedTweetResults">
        <!-- ko foreach: tweets -->
        <li>
            <ul>
                <li data-bind="text: 'User.ScreenName:' + TwitterUserId"></li>
                <li data-bind="text: 'User.Text:' + Text"></li>
                <li data-bind="text: 'User.Date:' + CreatedDate"></li>
                <li data-bind="text: 'ID:' + Id"></li>
                <li><a href="#" data-bind="attr: { href: url }">Go to tweet</a></li>
            </ul>

        </li>
        <!-- /ko -->
    </ul>

</div>
<script>
    $(function () {
        var blockAfterTimeout;
        $("#slider-range").slider({
            range: true,
            min: -24,
            max: 0,
            values: [-6, 0],
            slide: function (event, ui) {
                clearTimeout(blockAfterTimeout);
                blockAfterTimeout = setTimeout(function () { console.log('science!'); }, 500);
                if (ui.values[0] >= ui.values[1]) return false;
                
                $("#amount").val(-ui.values[0] + " hours to " + -ui.values[1] + " hours ago");
            }
        });
        $("#amount").val(-$("#slider-range").slider("values", 0) + " hours to " + (-$("#slider-range").slider("values", 1)) + " hours ago");
    });
</script>

<script>
    function viewModel(model) {
        var self = {};
        self.words = ko.observableArray();
        self.tweets = ko.observableArray();
        model.forEach(function (item) {
            self.words.push(word(item));
        });

        self.loadTweets = function (url) {
            $.post(url, function (response) {
                self.tweets([]);
                response.forEach(function (item) {
                    self.tweets.push(tweet(item));
                });
            });
        };

        return self;
    };

    function word(item) {
        var self = {};
        self.word = item.word;
        self.total = item.total;

        self.getExpandedTweetsUrl = '@Url.Action("RecentTweets")' + '/' + item.searchId + '?word=' + self.word;

        self.getExpandedTweets = function () {
            viewModel.loadTweets(self.getExpandedTweetsUrl);
        };

        return self;
    }

    function tweet(item) {
        var self = {};
        self.TwitterUserId = item.TwitterUserId;
        self.TwitterUserScreenName = item.TwitterUserScreenName;
        self.Text = item.Text;
        self.CreatedDate = item.CreatedDate;
        self.Id = item.Id;
        self.url = "https://twitter.com/" + self.TwitterUserScreenName + "/status/" + self.Id;
        return self;
    }

    var viewModel = new viewModel(@Html.Raw(Json.Encode(Model)));
    ko.applyBindings(viewModel);
</script>